#!/usr/bin/env bash
set -euo pipefail

cleanup() {
  echo "â¹  Stopping container 'pvzge'..."
  docker stop pvzge >/dev/null 2>&1 || true
}
trap cleanup EXIT

# 1) Always pull the latest image
echo "â¬‡ï¸  Pulling gaozih/pvzge:latestâ€¦"
docker pull gaozih/pvzge:latest

# 2) Ensure container is running
if docker ps --filter "name=^/pvzge$" --format '{{.Names}}' | grep -q '^pvzge$'; then
  echo "âœ…  Container 'pvzge' already running."
elif docker ps -a --filter "name=^/pvzge$" --format '{{.Names}}' | grep -q '^pvzge$'; then
  echo "ğŸ”„  Starting stopped container 'pvzge'..."
  docker start pvzge
else
  echo "ğŸš€  Creating & starting container 'pvzge'..."
  docker run --name pvzge -d -p 8080:80 gaozih/pvzge:latest
fi

# 3) Ensure Firefox profile exists
PROFILES_INI="$HOME/.mozilla/firefox/profiles.ini"
PROFILE_NAME="PvZ_Gardenless"

if ! grep -q "^Name=${PROFILE_NAME}$" "$PROFILES_INI" 2>/dev/null; then
  echo "ğŸ†•  Creating Firefox profile '${PROFILE_NAME}'â€¦"
  firefox -CreateProfile "${PROFILE_NAME}"
fi

# 4) Launch Firefox with that profile
echo "ğŸŒ  Opening Firefox (${PROFILE_NAME}) at http://localhost:8080 â€¦"
firefox --new-instance -P "${PROFILE_NAME}" --new-window "http://localhost:8080"

echo "ğŸ–¥ï¸  Firefox closed â€” exiting."
# trap on EXIT will stop the container
